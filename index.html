<!DOCTYPE html>
<html lang="en-us">
<head>
<title>Brython</title>
<meta charset="UTF-8"/>
<meta name="format-detection" content="telephone=no"/>
<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />
<link rel="stylesheet" href="www/res/bootstrap.min.css"/>
<link rel="stylesheet" href="www/css/app.css"/>
<script src="www/res/zepto.min.js"></script>
<!--
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
-->
<script src="www/res/bootstrap.min.js"></script>
<script src="www/res/phaser.min.js"></script>
<script src="www/js/world.js"></script>
<script src="www/js/units.js"></script>
<script>
// Global Variables
var width, game;
var scale = { x:.5, y:.5 };
var activeUnit = -1;

$(document).ready(function() {
width = Math.max(Math.min($(document).width() * .95, 900), 600);
// Build Game
game = new Phaser.Game(width, Math.floor(width * 16 / 9), Phaser.CANVAS, 'main', {
preload : function() {
//	game.load.image('background', 'www/img/terrain/grass.jpg'); // TODO: Get water/sea background
	// Load Terrain Images
	$.each(['grass', 'water'], function(i, val) {
		game.load.image('tile.' + val, 'www/img/tiles/' + val + '.png');
	});
	// Load Overlay Images
	$.each(['roman', 'britton', 'saxon'], function(i, faction) {
		game.load.image('city.' + faction, 'www/img/overlays/city-' + faction + '.png');
		$.each(unitTypes, function(unit, stats) {
			game.load.image('unit.' + faction + '.' + unit, 'www/img/' + faction + '/' + unit + '.png');
		});
	});
	game.stage.backgroundColor = 'lightseagreen';
},
create : function() {
/*	// Add Background and Scale to Size
	var background = game.add.tileSprite(0, 0, 1024, 1024, 'background');
	background.scale.y = game.height / background.height;
	background.scale.x = game.width / background.width;
//*/
	// Build the Board
	$.each(world, function(i, item) {
		var x = item.col * 74 + 20;
		var y = item.row * 86 + (item.col % 2 ? 43 : 0);
		$.extend(world[i], game.add.tileSprite(x, y, 200, 200, 'tile.' + item.terrain));
		world[i].scale.x = scale.x;
		world[i].scale.y = scale.y;
		game.add.text(x+30, y+50, world[i].col + '×' + world[i].row, {
			font: '12pt Arial', fill: 'lightgrey', align: 'center'
		});
		// Add City Overlay
		if (world[i].city) {
			world[i].overlay = game.add.tileSprite(x, y, 200, 200, 'city.' + world[i].city);
			world[i].overlay.scale.x = scale.x;
			world[i].overlay.scale.y = scale.y;
		}
	});

	// Place Starting Units
	$.each(units, function(i, unit) {
		var x = unit.col * 74 + 20;
		var y = unit.row * 86 + (unit.col % 2 ? 43 : 0);
		$.extend(units[i], game.add.sprite(x, y, 'unit.' + unit.faction + '.' + unit.uType));
		units[i].anchor = {x:.5,y:.5};
		units[i].scale.x = scale.x;
		units[i].scale.y = scale.y;
		if (unit.faction == 'britton') {
			activeUnit = i;
			units[i].setInteractive(true);
		}
	});
game.input.keyboard.addKeyCapture([
	Phaser.Keyboard.U,
	Phaser.Keyboard.I,
	Phaser.Keyboard.O,
	Phaser.Keyboard.J,
	Phaser.Keyboard.K,
	Phaser.Keyboard.L
]);
game.input.keyboard.addCallbacks(game, function(event) {
	// On Key Down
	if (!(activeUnit >= 0)) return false;
units[activeUnit].body.velocity.x = 0;
units[activeUnit].body.velocity.y = 0;
var x = units[activeUnit].col * 74 + 20;
var y = units[activeUnit].row * 86 + (units[activeUnit].col % 2 ? 43 : 0);
	switch (event.keyCode) {
	case Phaser.Keyboard.U:
		if (units[activeUnit].col % 2 == 0)
			units[activeUnit].row--;
		units[activeUnit].col--;
		break;
	case Phaser.Keyboard.I:
		units[activeUnit].row--;
		break;
	case Phaser.Keyboard.O:
		if (units[activeUnit].col % 2 == 0)
			units[activeUnit].row--;
		units[activeUnit].col++;
		break;
	case Phaser.Keyboard.J:
		if (units[activeUnit].col % 2 == 1)
			units[activeUnit].row++;
		units[activeUnit].col--;
		break;
	case Phaser.Keyboard.K:
		units[activeUnit].row++;
		break;
	case Phaser.Keyboard.L:
		if (units[activeUnit].col % 2 == 1)
			units[activeUnit].row++;
		units[activeUnit].col++;
		break;
	default:
		return false;
	}
//for (i in units[activeUnit]) {
//	if (typeof units[activeUnit][i] == 'function')
//		console.log('units[activeUnit].' + i + '()');
//	else
//		console.log('units[activeUnit].' + i + ' = ' + units[activeUnit][i]);
//}
console.log('moving ' + units[activeUnit].uType + ' to ' + units[activeUnit].col + 'x' + units[activeUnit].row);
//units[activeUnit].body.x = x;
//units[activeUnit].body.y = y;
x = units[activeUnit].col * 74 + 20;
y = units[activeUnit].row * 86 + (units[activeUnit].col % 2 ? 43 : 0);
//units[activeUnit].reset(x, y);
//console.log(units[activeUnit].uType + ' at ' + units[activeUnit].x + ',' + units[activeUnit].y);
units[activeUnit].x = x;
units[activeUnit].y = y;
units[activeUnit].body.velocity.x = 0;
units[activeUnit].body.velocity.y = 0;
console.log('moving ' + units[activeUnit].uType + ' to ' + x + ',' + y);
game.physics.moveToXY(units[activeUnit], x, y);
});
//*/
},
update : function() {
/*
var pntEnd = {
	x: units[activeUnit].col * 74 + 20,
	y: units[activeUnit].row * 86 + (units[activeUnit].col % 2 ? 43 : 0)
};
//console.log(units[activeUnit].uType + ' at ' + units[activeUnit].x + ',' + units[activeUnit].y);
if (Math.abs(units[activeUnit].body.x - pntEnd.x) <= 5 && Math.abs(units[activeUnit].body.y - pntEnd.y) <= 50) {
units[activeUnit].body.velocity.x = 0;
units[activeUnit].body.velocity.y = 0;
units[activeUnit].body.x = pntEnd.x;
units[activeUnit].body.y = pntEnd.y;
} else {
game.physics.moveToXY(units[activeUnit], pntEnd.x, pntEnd.y);
}
//*/
stopUnits();
//if(game.input.keyboard.isDown(Phaser.Keyboard.I)) {
//console.log('I pressed');
//	units[activeUnit].row--;
//var	x = units[activeUnit].col * 74 + 20;
//var	y = units[activeUnit].row * 86 + (units[activeUnit].col % 2 ? 43 : 0);
//console.log(units[activeUnit].uType + ' at ' + units[activeUnit].x + ',' + units[activeUnit].y);
//game.physics.moveToXY(units[activeUnit], x, y, 60);
//}
//	if (activeUnit >= 0 && units[activeUnit]) {
//		units[activeUnit].x = units[activeUnit].col * 74 + 20;
//		units[activeUnit].y = units[activeUnit].row * 86 + (units[activeUnit].col % 2 ? 43 : 0);
//	}
},
render : function() {
//game.debug.renderSpriteBody(units[activeUnit]);
//game.debug.renderText('hello world', 16, 32);
}
}); // end new Phaser.Game
}); // end document.ready
function moveUnit(unit, row, col) {
	// Calculate tile point
	var x = col * 74 + 20;
	var y = row * 86 + (col % 2 ? 43 : 0);
	// Clear unit movement
	unit.body.velocity.x = 0;
	unit.body.velocity.y = 0;
	unit.body.x = unit.x;
	unit.body.y = unit.y;
	// Save target point
	unit.x = x;
	unit.y = y;
	// Move unit
	game.physics.moveToXY(unit, x, y);
}
function stopUnits() {
	$.each(units, function(i, unit) {
		// 'return true' == 'continue'
		// 'return false' == 'break'
		if (unit.body.velocity.x == 0 && unit.body.velocity.y == 0)
			return true;
//		unit.body.velocity.x = 0;
//		unit.body.velocity.y = 0;
console.log('moving ' + unit.uType + ' from ' + unit.body.x + ',' + unit.body.y + ' to ' + unit.x + ',' + unit.y);
		if (Math.abs(unit.body.x - unit.x) <= 5 && Math.abs(unit.body.y - unit.y) <= 50) {
			unit.body.x = unit.x;
			unit.body.y = unit.y;
			unit.body.velocity.x = 0;
			unit.body.velocity.y = 0;
		}// else game.physics.moveToXY(unit, unit.x, unit.y);
	});
}
</script>
</head>
<body>
<header><h1>Brython</h1></header>
<main>
<p>Welcome to Brython, a land of simple farmers. The Romans call this land Britannia like they own it, but they leave us
alone as long we leave them alone. A nice thing about a large protective force is that our land has been at peace for more
than three centuries. But the world is changing. More and more Roman legionaries are redeploying to their troubled
provinces in the east. Trade with the rest of the empire is becoming more and more sporadic as civil wars ravage throughout
the empire in the name of one general or another. Barbarians from the north and across the seas are raiding the
countryside.</p>
<p>So, Welcome to Brython. Can you lead the people through these turbulent times?</p>
<div id="keyboard"></div>
</main>
</body>
</html>